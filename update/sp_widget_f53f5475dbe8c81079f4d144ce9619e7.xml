<?xml version="1.0" encoding="UTF-8"?><record_update table="sp_widget">
    <sp_widget action="INSERT_OR_UPDATE">
        <category>custom</category>
        <client_script><![CDATA[function($scope, $rootScope, $timeout, $location, $window, $document, $sce, spUtil, u_cutassp) {
    if (u_cutassp.utilIsValueValidAndTrue($scope.data.uSettings.isDebugOn)) {
        console.log((new Date()).getTime() + '.Client - ' + $scope.data.infotag);
    }
    /* widget controller */
    var c = this;

    c.myLabel = function(_p) {
        return u_cutassp.fmtLabel(_p);
    };
    c.myLog = function() {
        if (u_cutassp.utilIsValueValidAndTrue($scope.data.uSettings.isDebugOn)) {
            console.log((new Date()).getTime() + '.HTML View - ' + $scope.data.infotag);
        }
        return '';
    };
    //
    $window.ignorePopState = true;
    //	
    var isMsIeEdge;
    var newPath;
    var newSp;
    if ($window.noredirect) {
        directUrlStr = $window.llocationabsurl;
        directUrlObj = new URL(directUrlStr)
        newPath = directUrlObj.pathname;
        isMsIeEdge = (urlObj.searchParams) ? false : true;
        if (isMsIeEdge) {
            newSp = u_cutassp.getParamList(urlObj.search);
            for (pkey in newSp) {
                $location.search(pkey, newSp[pkey]);
            }
        } else {
            newSp = urlObj.searchParams;
            newSp.forEach(
                function(value, key) {
                    $location.search(key, value);
                }
            );
        }
        c.data.newPath = newPath;
        $window.noredirect = null;
        $window.llocationabsurl = null;
        $timeout(
            function() {
                $location.path(c.data.newPath);
            }
        );
    } else {
		//debugger;
        var urlObj = new URL($scope.data.newHref);
        var newHost = urlObj.host.toLowerCase();
        if ((newHost) && (newHost.indexOf('service-now.com') < 0)) {
            c.data.href = urlObj.href;
            $timeout(
                function() {
                    $window.open(c.data.href);
                }
            );
        } else {
            newPath = urlObj.pathname;
            isMsIeEdge = (urlObj.searchParams) ? false : true;
            if (isMsIeEdge) {
                newSp = u_cutassp.getParamList(urlObj.search);
                for (pkey in newSp) {
                    $location.search(pkey, newSp[pkey]);
                }
            } else {
                newSp = urlObj.searchParams;
                newSp.forEach(
                    function(value, key) {
                        $location.search(key, value);
                    }
                );
            }
            //c.data.url = $location.url();
            //c.data.absurl = $location.absUrl();
            c.data.newPath = newPath;
			
            $timeout(
                function() {
					//debugger;
                    $location.path(c.data.newPath);
					//$window.location.hreF = $location.url();
                }
            );
        }
    }
}]]></client_script>
        <controller_as>c</controller_as>
        <css/>
        <data_table>sp_instance</data_table>
        <demo_data/>
        <description/>
        <docs/>
        <field_list/>
        <has_preview>false</has_preview>
        <id>utassp01_kb_article_redirect_widget</id>
        <internal>false</internal>
        <link><![CDATA[function link(scope, element, attrs, controller) {  }]]></link>
        <name>UTASSP KB Article Redirect Widget</name>
        <option_schema>[
  {
    "name": "color",
    "label": "Color",
    "type": "choice",
    "choices": [
      {
        "label": "Default",
        "value": "default"
      },
      {
        "label": "Custom",
        "value": "custom"
      },
      {
        "label": "Primary",
        "value": "primary"
      },
      {
        "label": "Success",
        "value": "success"
      },
      {
        "label": "Info",
        "value": "info"
      },
      {
        "label": "Warning",
        "value": "warning"
      },
      {
        "label": "Danger",
        "value": "danger"
      }
    ]
  },
  {
    "name": "knowledge_base",
    "label": "Knowledge Base",
    "type": "choice",
    "choices": [
      {
        "label": "Business Affairs Internal",
        "value": "Business Affairs Internal"
      },
      {
        "label": "Business Affairs Knowledge Base",
        "value": "Business Affairs Knowledge Base"
      },
      {
        "label": "OIT Internal",
        "value": "OIT Internal"
      },
      {
        "label": "OIT Knowledge Base",
        "value": "OIT Knowledge Base"
      },
      {
        "label": "Public Knowledge Base",
        "value": "Public Knowledge Base"
      }
    ]
  },
  {
    "hint": "Maximum number of elements that are shown",
    "name": "maxitems",
    "default_value": "20",
    "label": "Max number of elements shown in the list (only positive numbers &gt; 0, 20 otherwise)",
    "type": "integer"
  }
]</option_schema>
        <public>true</public>
        <roles/>
        <script><![CDATA[(function($sp, input, data, options, gs) {
    var myU = new u_utassp();
    var myG = new global.u_utaglobalapi();
    // 
    data.uSettings = myU.utilGetInstanceSettings($sp);
    // *** Start: Debug only code *** //
    data.infotag = '';
    if (myU.utilIsValueValidAndTrue(data.uSettings.isDebugOn)) {
        data.infotag = myU.utilLog($sp);
    }
    // *** End: Debug only code *** //
    //
    // is logged in?
    var isLoggedIn = gs.isLoggedIn();

    // get page kb number
    var myUrl = gs.getProperty('glide.servlet.uri');
    var URL = new global.u_URL(myUrl);
    URL.pathname = $sp.getPortalRecord().getValue('url_suffix');
	var mySysId = $sp.getParameter('sys_id');
	//gs.info('mySysId: {0}', mySysId);
	var isSysId = myU.utilIsValueValid(mySysId);
	//gs.info('isSysId: {0}',isSysId);
    var myKbNum = $sp.getParameter('kbnumber');
	//gs.info('myKbNum: {0}',  myKbNum);
    //var myLevel = $sp.getParameter('level');
	//gs.info('kbar server: level: '+JSON.stringify(myLevel));
    var isKbNum = myU.utilIsValueValid(myKbNum);
	//gs.info('isKbNum: {0}',  isKbNum);
    //var isLevel = myU.utilIsValueValid(myLevel);
	if (isKbNum) {
        var isFound = false;
        var articleData = {};
        if (!isLoggedIn) {
            articleData = myU.getKbPublicArticleByKbNum(myKbNum);
            if (!(articleData.rowCount > 0)) {
				articleData.sys_id=0;
			}
            isFound = true;
        } else {
            articleData = myU.getKbArticleByKbNum(myKbNum);
            if (articleData.rowCount > 0) {
                var articleGr = new GlideRecord('kb_knowledge');
                if (articleGr.get(articleData.sys_id)) {
                    if (articleGr.canRead()) {
                        isFound = true;
                    }
                }
            } else {
                isFound = true;
            }
        }
        if (isFound) {
            URL.searchParams.set('id', 'utassp01_kb_article');
            URL.searchParams.set('sys_id', articleData.sys_id);
            URL.searchParams.set('kbnumber', myKbNum);
            //if (isLevel) {
            //    URL.searchParams.set('level', myLevel);
            //}
        } else {
            //URL.searchParams.set('id', 'utassp02_kb_public_knowledge_base');
            URL.searchParams.set('id', 'utassp01_index');
        }
    } else 	if (isSysId) {
		var gr = new GlideRecord('kb_knowledge');
		if (gr.get(mySysId)){
			myKbNum = gr.number;			
		}
		URL.searchParams.set('id', 'utassp01_kb_article');
		URL.searchParams.set('sys_id',mySysId);
		URL.searchParams.set('kbnumber', myKbNum);
	}
    //populate the 'data' variable
	gs.info('data.newHref: {0}',data);
    data.newHref = URL.getURL();
})($sp, input, data, options, gs);]]></script>
        <servicenow>false</servicenow>
        <sys_class_name>sp_widget</sys_class_name>
        <sys_created_by>welchv</sys_created_by>
        <sys_created_on>2019-10-17 20:15:36</sys_created_on>
        <sys_customer_update>false</sys_customer_update>
        <sys_id>f53f5475dbe8c81079f4d144ce9619e7</sys_id>
        <sys_mod_count>145</sys_mod_count>
        <sys_name>UTASSP KB Article Redirect Widget</sys_name>
        <sys_package display_value="utassp" source="x_287765_utassp">2e58c8624f112300f006121f9310c726</sys_package>
        <sys_policy/>
        <sys_replace_on_upgrade>false</sys_replace_on_upgrade>
        <sys_scope display_value="utassp">2e58c8624f112300f006121f9310c726</sys_scope>
        <sys_update_name>sp_widget_f53f5475dbe8c81079f4d144ce9619e7</sys_update_name>
        <sys_updated_by>welchv</sys_updated_by>
        <sys_updated_on>2020-06-12 21:02:23</sys_updated_on>
        <template><![CDATA[<div> 
</div> 



]]></template>
    </sp_widget>
</record_update>
